# 茨木市統計データ可視化システム 要件定義・仕様

## 1. 目的
- 大阪府茨木市の統計データ（国勢調査、経済センサス等）を、地図上に重ねて可視化・分析する。  
- CSV と Shapefile をローカルで読み込み、ブラウザ内だけで処理を完結させる。

## 2. システム概要
- **形態**: ブラウザ上で動作するシングルページアプリケーション（SPA）。
- **実行環境**: クライアントサイドのみ（同梱データを読み込み、ブラウザ内で処理）。

## 3. データ要件
### 3.1 入力データ
- **同梱データ (/data) を初期ロード**
  - 地図境界データ (Shapefile)
    - 展開済み（.shp/.shx/.dbf/.prj/.cpg）。
    - 置き場所: `/data/茨木_地図/r2ka27211.*`
    - KEY_CODE もしくは 市区町村コード + 町丁字コード を含む。
    - DBF の日本語が文字化けしないよう、.cpg で Shift_JIS を指定する。
  - 人口データ (h03, CSV)
    - 男女・年齢階級別人口。
    - Shift_JIS または UTF-8 を想定。
  - 世帯データ (h06, CSV)
    - 世帯の家族類型別データ（階層構造）。
    - Shift_JIS または UTF-8 を想定。
- **事業所データ (CSV)**
  - 同梱されていない場合は未読込扱い。
  - 事業所数や従業者数など数値列を含む任意形式。

### 3.2 文字コード
- CSV: Shift_JIS / UTF-8 の自動判定。
- Shapefile: .cpg で DBF の文字コード（例: Shift_JIS）を明示する。

### 3.3 結合キー
- KEY_CODE を優先。
- KEY_CODE が無い場合は **市区町村コード + 町丁字コード** を結合。
- Shapefile に複数桁数の KEY_CODE が混在する場合は、
  **市区町村コード + 町丁字コードをそのまま結合したキーを優先**し、
  合致しない場合に **複数桁数へパディングして既存の KEY_CODE と照合**する。

## 4. 機能要件
### 4.1 地図表示・操作
- 白背景上に町丁・字区画を描画。
- ズームイン/アウト、パン操作が可能。
- マウスオーバーで地名・値をツールチップ表示。

### 4.2 鉄道オーバーレイ
- JR京都線、阪急京都線、大阪モノレール本線/彩都線を描画。
- 万博記念公園駅と宇野辺駅は路線間の接続線で補完表示。
- 駅名ラベルを表示。
- **線の太さ**および**駅マーカーサイズ**は UI から調整可能。

### 4.3 データ可視化モード
- **人口モード**
  - 性別（男・女・総数）および年齢階級を選択し合算。
  - YlOrRd のグラデーションで塗り分け。
- **世帯モード**
  - 世帯員の年齢による世帯の種類を行指定。
  - 階層構造の家族類型から 1 つ選択。
  - Greens のグラデーションで塗り分け。
- **事業所モード**
  - CSV 内の数値列を選択。
  - Purples のグラデーションで塗り分け。
- **分析モード（特化係数）**
  - 分子（家族類型）をプルダウンから選択。
  - 分母は総数列を使用。
  - 市平均比率との比（特化係数）を RdBu（青→白→赤）で表示。

### 4.4 凡例・スケール
- 各モードで自動的に最小値/最大値を算出して凡例に表示。
- 分析モードは 1.0 を基準として赤=特化、青=非特化。

### 4.5 飲食店カテゴリフィルタ
- 飲食店モードにカテゴリフィルタを設け、評価フィルタと同様に複数選択で絞り込み可能。
- CSVの「店のカテゴリ(キーワード)」は複数カテゴリを想定し、区切り記号（、 / , / ／ / ・）で分割して扱う。
- 店舗は**選択されたカテゴリのいずれかを含む場合に表示対象**とする（OR条件）。
- カテゴリが空の店舗は「カテゴリなし」として扱い、フィルタで個別に選択できる。
- 初期状態は全カテゴリ選択（=未絞り込み）。

## 5. 非機能要件
- **パフォーマンス**: 数千件程度のレコードを数秒以内に解析・描画。
- **セキュリティ**: 同梱データはサーバへ送信せず、ブラウザ内のみで処理。
- **ユーザビリティ**: 起動時に同梱データを自動読込して地図を表示。

## 6. UI構成
- **メインエリア**: 地図表示領域。
- **コントロールパネル**:
  - モード切替タブ
  - 同梱データの読み込み状況
  - 各モードのフィルタ
  - 鉄道線の太さ / 駅マーカーサイズ
- **凡例パネル**: 色と数値範囲の表示。
